<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>Empty Line Remover</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <h2>Empty Line Remover</h2>

        <div class="file-upload-container">
            <div class="file-upload-controls">
                <input type="file" id="fileInput" accept=".csv, .xls, .xlsx" style="display: none;">
                <button class="pdf-upload-btn" id="selectFileBtn">
                    <i class="fas fa-folder-open"></i> Select File
                </button>
                <div id="dropArea" class="drop-area">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Drag & Drop CSV/Excel file here</p>
                </div>
            </div>
            <div id="statusMessage" class="status-message" style="display: none;"></div>
        </div>

        <div id="output" style="display: none;">
            </div>

        <div style="text-align: center; margin-top: 20px;">
            <button id="downloadExcelBtn">Download as Excel</button>
        </div>
    </div>

    <button id="returnToTop" aria-label="Return to top">
        <i class="fas fa-arrow-up"></i>
    </button>

    <footer class="copyright-bar">
  <div class="copyright-content">
    <span>&copy; 2025 Clean Columns</span>
    <span class="divider">•</span>
    <span>All rights reserved</span>
    <span class="divider">•</span>
    <span>Qzee</span>
    <button id="darkModeToggle" class="toolbar-btn" title="Toggle Dark Mode"><i class="fas fa-moon"></i></button>
      <button id="returnToTop" title="Return to Top">
    <i class="fas fa-arrow-up"></i>
  </button>
  </div>
</footer>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const fileInput = document.getElementById('fileInput');
  const selectFileBtn = document.getElementById('selectFileBtn');
  const dropArea = document.getElementById('dropArea');
  const downloadExcelBtn = document.getElementById('downloadExcelBtn');
  const statusMessage = document.getElementById('statusMessage');

  let processedWorkbook = null;
  let originalFileName = 'cleaned_data';

  function showStatus(msg, type) {
    statusMessage.textContent = msg;
    statusMessage.className = `status-message ${type}`;
    statusMessage.style.display = 'block';
    setTimeout(() => (statusMessage.style.display = 'none'), 5000);
  }

  selectFileBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
  dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('highlight'); });
  dropArea.addEventListener('dragleave', () => dropArea.classList.remove('highlight'));
  dropArea.addEventListener('drop', e => {
    e.preventDefault(); dropArea.classList.remove('highlight');
    if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
  });

  function handleFile(file) {
    if (!file) return;
    originalFileName = file.name.replace(/\.[^/.]+$/, "");
    const reader = new FileReader();

    reader.onload = e => {
      const data = new Uint8Array(e.target.result);

      // Read workbook **as raw text**, no conversions at all
      const wb = XLSX.read(data, {
        type: 'array',
        cellText: true,
        cellDates: false,
        cellNF: true,
        raw: true
      });

      for (const name of wb.SheetNames) {
        const ws = wb.Sheets[name];
        removeEmptyRows(ws);
      }

      processedWorkbook = wb;
      downloadExcelBtn.style.display = 'block';
      showStatus('File processed — empty rows removed.', 'success');
    };

    reader.readAsArrayBuffer(file);
  }

  // Only remove rows that are truly empty (no defined cells or only blank)
  function removeEmptyRows(ws) {
    if (!ws['!ref']) return;
    const range = XLSX.utils.decode_range(ws['!ref']);
    const newWs = {};
    let newRow = 0;

    for (let r = range.s.r; r <= range.e.r; r++) {
      let empty = true;
      for (let c = range.s.c; c <= range.e.c; c++) {
        const addr = XLSX.utils.encode_cell({ r, c });
        const cell = ws[addr];
        if (cell && cell.v !== undefined && String(cell.v).trim() !== '') {
          empty = false;
          break;
        }
      }
      if (!empty) {
        for (let c = range.s.c; c <= range.e.c; c++) {
          const oldAddr = XLSX.utils.encode_cell({ r, c });
          const newAddr = XLSX.utils.encode_cell({ r: newRow, c });
          if (ws[oldAddr]) newWs[newAddr] = ws[oldAddr];
        }
        newRow++;
      }
    }

    ws['!ref'] = XLSX.utils.encode_range(
      { r: 0, c: range.s.c },
      { r: Math.max(0, newRow - 1), c: range.e.c }
    );

    // Replace cells
    for (const k in ws) if (!k.startsWith('!')) delete ws[k];
    Object.assign(ws, newWs);
  }

  downloadExcelBtn.addEventListener('click', () => {
    if (!processedWorkbook) return showStatus('No data to download.', 'error');

    // Write file **without changing any data or formats**
    XLSX.writeFile(processedWorkbook, `${originalFileName}_cleaned.xlsx`, {
      cellDates: false,
      cellNF: true,
      raw: true
    });
  });
});
</script>

</body>
</html>
